<html>
<head>
<script>
	function pad(x, len) {
		var str = '' + x;
		while (str.length < len) str = '0' + str;
		return str;
	}
	
	function getCurrentDateTime() {
		var now = new Date();
		return now.getFullYear() + '-' + pad(now.getMonth()+1,2) + '-' + pad(now.getDate(),2) + ' ' + now.getHours() + ':' + pad(now.getMinutes(),2);
	}
	
	function changeIcon() {
		chrome.browserAction.setIcon({'path':'icon-done.png'});
		setTimeout("chrome.browserAction.setIcon({'path':'icon.png'});", 1500);
	}
	
	// wtf localstorage
	function toBool(str) { return str.toLowerCase().charAt(0) == "t"; }
	
	// Called when the user clicks on the browser action.
	chrome.browserAction.onClicked.addListener(function(currentTab) {
		var saveIncognito = toBool(localStorage['saveIncognito']);
		var parentFolderId = localStorage['bookmarkFolderId'];
		
		// default settings:
		if (!localStorage['firstStart']) {
			localStorage['saveIncognito'] = false;
			localStorage['bookmarkFolderId'] = 1;
			localStorage['firstStart'] = 1;
		}
		
		chrome.tabs.getAllInWindow(currentTab.windowId, function(tabs){
			// Don't save an empty folder
			var foundNonIncognitoTab = false;
			if (!tabs.length) return;
			if (!saveIncognito) {
				for (var i=0; i<tabs.length; i++) {
					if (!tabs[i].incognito) {
						foundNonIncognitoTab = true;
						break;
					}
				}
				if (!foundNonIncognitoTab) return;
			}
			chrome.bookmarks.create({
				'parentId': parentFolderId,
				'title':    getCurrentDateTime()
			}, function(folder){
				for (var i=0; i<tabs.length; i++) {
					if (!tabs[i].incognito || saveIncognito) {
						chrome.bookmarks.create({
							'parentId': folder.id,
							'index':    i,
							'title':    tabs[i].title,
							'url':      tabs[i].url
						});
					}
				}
			});
			changeIcon();
		});
	});
</script>
</head>
</html>